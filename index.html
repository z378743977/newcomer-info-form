<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¤šè¯­è¨€è¡¨å•å¡«å†™åº”ç”¨ï¼ˆç§»åŠ¨ç«¯ä¸‹è½½å…¼å®¹ç‰ˆï¼‰</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { min-height:100vh; position:relative; }
    body {
      font-family: -apple-system,BlinkMacSystemFont,'Segoe UI','Microsoft YaHei',sans-serif;
      background: linear-gradient(135deg, #F5F5F0 0%, #D4E4E7 50%, #B8D4D6 100%);
      min-height:100vh; padding:20px; position:relative; overflow-x:hidden;
    }
    body::before {
      content:''; position:fixed; top:-50%; right:-50%; width:200%; height:200%;
      background: radial-gradient(circle, rgba(74,144,164,.05) 0%, transparent 70%);
      animation: rotate 30s linear infinite; pointer-events:none; z-index:0;
    }
    @keyframes rotate { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    #app { position:relative; z-index:1; }
    .container {
      max-width:500px; margin:0 auto; background:#FAFAF8; border-radius:12px;
      box-shadow:0 10px 40px rgba(46,79,122,.15); padding:30px;
      border:1px solid rgba(62,95,138,.1);
    }
    .admin-container { max-width:1400px; }
    h1 { text-align:center; color:#2E4F7A; font-size:24px; margin-bottom:30px; font-weight:bold; }
    .admin-title { color:#1E3A5F; font-size:28px; }
    label { display:block; font-weight:600; font-size:14px; margin-bottom:8px; color:#2C3E50; transition:all .3s; }
    .form-group:hover label { color:#3E5F8A; transform:translateX(3px); }
    input[type='text'], input[type='date'], input[type='number'], select {
      width:100%; padding:10px 15px; border:2px solid #D4E4E7; border-radius:8px; font-size:14px; transition:all .3s; background:#fff;
    }
    input:focus, select:focus {
      outline:none; border-color:#3E5F8A; box-shadow:0 0 0 3px rgba(62,95,138,.1); transform:translateY(-2px); background:#FEFEFE;
    }
    .form-group{ margin-bottom:20px; }
    .language-buttons{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:30px; }
    .lang-btn, .tab-btn, .field-btn, .toggle-btn, .action-btn {
      padding:10px; border:none; border-radius:8px; background:#E8F0F2; color:#2C3E50; font-weight:500; cursor:pointer;
      transition:all .3s; border:1px solid rgba(62,95,138,.2);
    }
    .lang-btn:hover, .tab-btn:hover, .field-btn:hover, .toggle-btn:hover, .action-btn:hover { background:#D4E4E7; transform:translateY(-2px); box-shadow:0 4px 12px rgba(62,95,138,.15); }
    .lang-btn.active, .tab-btn.active { background:#3E5F8A; color:#fff; }
    .signature-container{ border:2px solid #B8D4D6; border-radius:8px; overflow:hidden; margin-top:10px; transition:all .3s; }
    .signature-container:hover{ border-color:#4A90A4; box-shadow:0 4px 16px rgba(74,144,164,.2); transform:scale(1.01); }
    canvas{ display:block; width:100%; background:#fff; cursor:crosshair; touch-action:none; }
    .clear-btn{ margin-top:10px; background:none; border:none; color:#C73E1D; font-size:14px; cursor:pointer; text-decoration:underline; }
    .clear-btn:hover{ color:#A32E15; }
    .generate-btn{
      width:100%; padding:15px; background:linear-gradient(135deg,#3E5F8A 0%, #2E4F7A 100%); color:#fff; border:none; border-radius:8px;
      font-size:16px; font-weight:600; cursor:pointer; margin-top:30px; transition:all .3s; display:flex; align-items:center; justify-content:center; gap:10px;
      box-shadow:0 4px 12px rgba(62,95,138,.2);
    }
    .generate-btn:hover{ background:linear-gradient(135deg,#2E4F7A 0%,#1E3A5F 100%); transform:translateY(-2px); box-shadow:0 6px 16px rgba(62,95,138,.3); }
    .note{ text-align:center; font-size:12px; color:#5A7A8F; margin-top:20px; }
    .admin-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; }
    .admin-layout{ display:grid; grid-template-columns:2fr 1fr; gap:30px; }
    .left-panel,.right-panel{
      background:#FAFAF8; padding:20px; border-radius:12px; box-shadow:0 2px 8px rgba(62,95,138,.1); border:1px solid rgba(62,95,138,.1);
    }
    .section-title{ font-size:18px; font-weight:700; color:#2E4F7A; margin-bottom:15px; padding-bottom:10px; border-bottom:2px solid #B8D4D6; }
    .template-tabs,.language-tabs{ display:flex; gap:10px; margin-bottom:20px; }
    .field-buttons{ display:flex; flex-wrap:wrap; gap:8px; margin-bottom:20px; }
    .preview-box{ border:2px solid #A8DADC; background:#F0F8F9; padding:15px; border-radius:8px; margin-bottom:20px; }
    .image-wrapper{ position:relative; display:inline-block; max-width:100%; }
    .preview-box img{ max-width:100%; cursor:crosshair; border:2px dashed #A8DADC; display:block; }
    #markersContainer{ position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }
    .field-marker{
      position:absolute; width:28px; height:28px; background:rgba(74,144,164,.9); color:#fff; border-radius:50%;
      display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; transform:translate(-50%,-150%);
      box-shadow:0 2px 8px rgba(62,95,138,.3); border:3px solid #fff; z-index:10;
    }
    .field-label{ position:absolute; background:rgba(74,144,164,.95); color:#fff; padding:4px 10px; border-radius:4px; font-size:11px; font-weight:600; transform:translate(-50%,-250%); white-space:nowrap; z-index:10; }
    .field-preview-text{ position:absolute; pointer-events:none; z-index:8; white-space:nowrap; opacity:.9; }
    .field-list{ margin-top:20px; }
    .field-item{ background:#F5F8F9; border:1px solid #D4E4E7; border-radius:8px; padding:12px; margin-bottom:10px; }
    .field-item-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .field-name{ font-weight:600; color:#2E4F7A; }
    .field-actions{ display:flex; gap:8px; }
    .edit-btn{ padding:4px 12px; border:none; border-radius:4px; cursor:pointer; font-size:12px; background:#3E5F8A; color:#fff; }
    .delete-btn{ padding:4px 12px; border:none; border-radius:4px; cursor:pointer; font-size:12px; background:#C73E1D; color:#fff; }
    .reposition-btn{ padding:4px 12px; border:none; border-radius:4px; cursor:pointer; font-size:12px; background:#F7B500; color:#fff; }
    .param-editor{ background:#fff; border:2px solid #3E5F8A; border-radius:8px; padding:15px; margin-top:10px; }
    .param-row{ display:grid; grid-template-columns:100px 1fr; gap:10px; margin-bottom:12px; align-items:center; }
    .param-label{ font-size:13px; font-weight:600; color:#2C3E50; }
    .save-param-btn{ width:100%; padding:8px; background:#4A90A4; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:600; }
    .upload-section{ margin-bottom:20px; padding:15px; background:#F5F8F9; border-radius:8px; border:1px solid #D4E4E7; }
    .mode-switch{ margin-top:15px; padding:12px; background:#F0F8F9; border:2px solid #A8DADC; border-radius:8px; display:flex; align-items:center; gap:10px; }
    .password-container{ max-width:400px; text-align:center; }
    .password-title{ font-size:24px; font-weight:700; color:#2E4F7A; margin-bottom:10px; }
    .password-subtitle{ color:#5A7A8F; margin-bottom:20px; font-size:14px; }
    .password-input{ width:100%; padding:15px; border:2px solid #D4E4E7; border-radius:8px; font-size:16px; margin-bottom:12px; text-align:center; letter-spacing:2px; background:#fff; }
    .password-btn{ width:100%; padding:15px; background:linear-gradient(135deg,#3E5F8A 0%, #2E4F7A 100%); color:#fff; border:none; border-radius:8px; font-size:16px; font-weight:600; cursor:pointer; }
    .password-error{ color:#C73E1D; font-size:14px; margin-top:10px; display:none; }
    .password-error.show{ display:block; }
    
    /* è™šæ‹Ÿé”®ç›˜æ ·å¼ */
    .virtual-keyboard {
      margin-top: 15px;
      padding: 15px;
      background: #F0F8F9;
      border-radius: 8px;
      border: 2px solid #B8D4D6;
    }
    .keyboard-title {
      font-size: 14px;
      font-weight: 600;
      color: #2E4F7A;
      margin-bottom: 10px;
      text-align: center;
    }
    .keyboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
      gap: 5px;
      max-height: 300px;
      overflow-y: auto;
    }
    .char-btn {
      padding: 10px 5px;
      background: #fff;
      border: 1px solid #D4E4E7;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: all .2s;
      text-align: center;
    }
    .char-btn:hover {
      background: #3E5F8A;
      color: #fff;
      transform: scale(1.05);
    }
    .char-btn:active {
      transform: scale(0.95);
    }
    .keyboard-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .keyboard-control-btn {
      flex: 1;
      padding: 8px;
      background: #E8F0F2;
      border: 1px solid #B8D4D6;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all .2s;
    }
    .keyboard-control-btn:hover {
      background: #D4E4E7;
    }
    .name-input-container {
      position: relative;
    }
    .keyboard-toggle-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: #3E5F8A;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      font-size: 12px;
      cursor: pointer;
      transition: all .2s;
    }
    .keyboard-toggle-btn:hover {
      background: #2E4F7A;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // ===================== å¤šè¯­è¨€ä¸å·¥ç§ =====================
    const translations = {
      zh:{ title:'å‘˜å·¥ä¿¡æ¯è¡¨å•', selectLanguage:'é€‰æ‹©è¯­è¨€', name:'å§“å', translateName:'ç¿»è¯‘', birthday:'ç”Ÿæ—¥', address:'åœ°å€', addressSearch:'æœç´¢åœ°å€', position:'èŒä½', positionCustom:'è‡ªå¡«', positionSelect:'é€‰æ‹©å·¥ç§', passport:'æŠ¤ç…§å·', phone:'æ‰‹æœºå·', experience:'å·¥ä½œç»å†', experienceYears:'å¹´', signature:'ç­¾å', clearSignature:'æ¸…é™¤ç­¾å', generate:'ç”Ÿæˆè¡¨å•', complete:'âœ… å®Œæˆå¡«å†™', downloadTitle:'ä¸‹è½½è¡¨å•', backToForm:'â† è¿”å›è¡¨å•', generateFirst:'â‘  ä¸‹è½½åŠ³åŠ¨åˆåŒ', generateSecond:'â‘¡ ä¸‹è½½å®‰å…¨åè®®', sendToAdmin:'â‘¢ å‘é€è‡³ç®¡ç†å‘˜', adminMode:'ç®¡ç†å‘˜æ¨¡å¼', userMode:'ç”¨æˆ·æ¨¡å¼', addressHint:'ğŸ’¡ åœ¨Naveråœ°å›¾ä¸­æœç´¢åœ°å€,ç„¶åå¤åˆ¶ç²˜è´´åˆ°è¾“å…¥æ¡†', downloadHint:'è¯·æŒ‰é¡ºåºä¸‹è½½ä¸¤ä¸ªè¡¨å•ï¼Œç„¶åå‘é€ç»™ç®¡ç†å‘˜', keyboardHint:'ğŸ’¡ ç‚¹å‡»å­—ç¬¦è¾“å…¥åå­—' },
      ko:{ title:'ì§ì› ì •ë³´ ì–‘ì‹', selectLanguage:'ì–¸ì–´ ì„ íƒ', name:'ì„±ëª…', translateName:'ë²ˆì—­', birthday:'ìƒë…„ì›”ì¼', address:'ì£¼ì†Œ', addressSearch:'ì£¼ì†Œ ê²€ìƒ‰', position:'ì§ì¢…', positionCustom:'ì§ì ‘ ì…ë ¥', positionSelect:'ì„ íƒ', residentNum:'ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸', phone:'ì „í™”ë²ˆí˜¸', experience:'ê²½ë ¥', experienceYears:'ë…„', signature:'ì„œëª…', clearSignature:'ì„œëª… ì§€ìš°ê¸°', generate:'ì–‘ì‹ ìƒì„±', complete:'âœ… ì‘ì„± ì™„ë£Œ', downloadTitle:'ì–‘ì‹ ë‹¤ìš´ë¡œë“œ', backToForm:'â† ì–‘ì‹ìœ¼ë¡œ ëŒì•„ê°€ê¸°', generateFirst:'â‘  ê·¼ë¡œê³„ì•½ì„œ ë‹¤ìš´ë¡œë“œ', generateSecond:'â‘¡ ì•ˆì „í˜‘ì•½ ë‹¤ìš´ë¡œë“œ', sendToAdmin:'â‘¢ ê´€ë¦¬ìì—ê²Œ ì „ì†¡', adminMode:'ê´€ë¦¬ì ëª¨ë“œ', userMode:'ì‚¬ìš©ì ëª¨ë“œ', addressHint:'ğŸ’¡ Naver ì§€ë„ì—ì„œ ì£¼ì†Œë¥¼ ê²€ìƒ‰í•œ í›„ ì…ë ¥ë€ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”', downloadHint:'ë‘ ì–‘ì‹ì„ ìˆœì„œëŒ€ë¡œ ë‹¤ìš´ë¡œë“œí•œ í›„ ê´€ë¦¬ìì—ê²Œ ì „ì†¡í•˜ì„¸ìš”', keyboardHint:'ğŸ’¡ ë¬¸ìë¥¼ í´ë¦­í•˜ì—¬ ì´ë¦„ ì…ë ¥' },
      vi:{ title:'Máº«u thÃ´ng tin nhÃ¢n viÃªn', selectLanguage:'Chá»n ngÃ´n ngá»¯', name:'Há» vÃ  tÃªn', translateName:'Dá»‹ch', birthday:'NgÃ y sinh', address:'Äá»‹a chá»‰', addressSearch:'TÃ¬m Ä‘á»‹a chá»‰', position:'Vá»‹ trÃ­', positionCustom:'Tá»± nháº­p', positionSelect:'Chá»n', passport:'Sá»‘ há»™ chiáº¿u', phone:'Sá»‘ Ä‘iá»‡n thoáº¡i', experience:'Kinh nghiá»‡m', experienceYears:'nÄƒm', signature:'Chá»¯ kÃ½', clearSignature:'XÃ³a chá»¯ kÃ½', generate:'Táº¡o máº«u', complete:'âœ… HoÃ n thÃ nh Ä‘iá»n', downloadTitle:'Táº£i xuá»‘ng máº«u', backToForm:'â† Quay láº¡i máº«u', generateFirst:'â‘  Táº£i há»£p Ä‘á»“ng lao Ä‘á»™ng', generateSecond:'â‘¡ Táº£i thá»a thuáº­n an toÃ n', sendToAdmin:'â‘¢ Gá»­i cho quáº£n trá»‹ viÃªn', adminMode:'Cháº¿ Ä‘á»™ quáº£n trá»‹', userMode:'Cháº¿ Ä‘á»™ ngÆ°á»i dÃ¹ng', addressHint:'ğŸ’¡ TÃ¬m kiáº¿m Ä‘á»‹a chá»‰ trÃªn báº£n Ä‘á»“ Naver, sau Ä‘Ã³ sao chÃ©p vÃ  dÃ¡n vÃ o Ã´ nháº­p', downloadHint:'Vui lÃ²ng táº£i xuá»‘ng hai máº«u theo thá»© tá»±, sau Ä‘Ã³ gá»­i cho quáº£n trá»‹ viÃªn', keyboardHint:'ğŸ’¡ Nháº¥p vÃ o kÃ½ tá»± Ä‘á»ƒ nháº­p tÃªn' },
      ru:{ title:'Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞµ', selectLanguage:'Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ·Ñ‹Ğº', name:'Ğ¤Ğ˜Ğ', translateName:'ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´', birthday:'Ğ”Ğ°Ñ‚Ğ° Ñ€Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ', address:'ĞĞ´Ñ€ĞµÑ', addressSearch:'ĞŸĞ¾Ğ¸ÑĞº Ğ°Ğ´Ñ€ĞµÑĞ°', position:'Ğ”Ğ¾Ğ»Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ', positionCustom:'Ğ’Ğ²ĞµÑÑ‚Ğ¸', positionSelect:'Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ', passport:'ĞĞ¾Ğ¼ĞµÑ€ Ğ¿Ğ°ÑĞ¿Ğ¾Ñ€Ñ‚Ğ°', phone:'Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½', experience:'ĞĞ¿Ñ‹Ñ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹', experienceYears:'Ğ»ĞµÑ‚', signature:'ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑŒ', clearSignature:'ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑŒ', generate:'Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ„Ğ¾Ñ€Ğ¼Ñƒ', complete:'âœ… Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾', downloadTitle:'Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ñ„Ğ¾Ñ€Ğ¼Ñ‹', backToForm:'â† Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğº Ñ„Ğ¾Ñ€Ğ¼Ğµ', generateFirst:'â‘  Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ñ‚Ñ€ÑƒĞ´Ğ¾Ğ²Ğ¾Ğ¹ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€', generateSecond:'â‘¡ Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ ÑĞ¾Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ¸Ğµ Ğ¾ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸', sendToAdmin:'â‘¢ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ', adminMode:'Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°', userMode:'Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ', addressHint:'ğŸ’¡ ĞĞ°Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ğ°Ğ´Ñ€ĞµÑ Ğ½Ğ° ĞºĞ°Ñ€Ñ‚Ğµ Naver, Ğ·Ğ°Ñ‚ĞµĞ¼ ÑĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ¸ Ğ²ÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ Ğ² Ğ¿Ğ¾Ğ»Ğµ Ğ²Ğ²Ğ¾Ğ´Ğ°', downloadHint:'ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚Ğµ Ğ´Ğ²Ğµ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ğ¿Ğ¾ Ğ¿Ğ¾Ñ€ÑĞ´ĞºÑƒ, Ğ° Ğ·Ğ°Ñ‚ĞµĞ¼ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ', keyboardHint:'ğŸ’¡ ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ½Ğ° ÑĞ¸Ğ¼Ğ²Ğ¾Ğ» Ğ´Ğ»Ñ Ğ²Ğ²Ğ¾Ğ´Ğ° Ğ¸Ğ¼ĞµĞ½Ğ¸' }
    };

    const positionOptions = {
      zh:['æ•´ç†','è€ç‚®','æ‹†é™¤','é’¢ç­‹','æµ‡ç­‘','æ¶å­å·¥','ä¿¡å·å‘˜','äºŒç‚®','é’¢ç‚®','ç¢çŸ³æŠ¹ç°','å®‰å…¨'],
      ko:['ì •ë¦¬','í˜•í‹€','í•´ì²´','ì² ê·¼','íƒ€ì„¤','ë¹„ê³„','ì‹ í˜¸ìˆ˜','ì•Œí¼','ê°±í¼','í• ì„ë¯¸ì¥','ì•ˆì „'],
      vi:['Dá»n dáº¹p','VÃ¡n khuÃ´n','PhÃ¡ dá»¡','Cá»‘t thÃ©p','Äá»• bÃª tÃ´ng','GiÃ n giÃ¡o','NhÃ¢n viÃªn tÃ­n hiá»‡u','VÃ¡n khuÃ´n nhÃ´m','VÃ¡n khuÃ´n lá»›n','TrÃ¡t Ä‘Ã¡ nghiá»n','An toÃ n'],
      ru:['Ğ£Ğ±Ğ¾Ñ€ĞºĞ°','ĞĞ¿Ğ°Ğ»ÑƒĞ±ĞºĞ°','Ğ”ĞµĞ¼Ğ¾Ğ½Ñ‚Ğ°Ğ¶','ĞÑ€Ğ¼Ğ°Ñ‚ÑƒÑ€Ğ°','Ğ—Ğ°Ğ»Ğ¸Ğ²ĞºĞ°','Ğ›ĞµÑĞ°','Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ»ÑŒÑ‰Ğ¸Ğº','ĞĞ»ÑĞ¼Ğ¸Ğ½Ğ¸ĞµĞ²Ğ°Ñ Ğ¾Ğ¿Ğ°Ğ»ÑƒĞ±ĞºĞ°','ĞšÑ€ÑƒĞ¿Ğ½Ğ¾Ñ‰Ğ¸Ñ‚Ğ¾Ğ²Ğ°Ñ Ğ¾Ğ¿Ğ°Ğ»ÑƒĞ±ĞºĞ°','Ğ¨Ñ‚ÑƒĞºĞ°Ñ‚ÑƒÑ€ĞºĞ° Ñ‰ĞµĞ±Ğ½ĞµĞ¼','Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ']
    };

    const positionMapping = {
      'æ•´ç†':'ì •ë¦¬','è€ç‚®':'í˜•í‹€','æ‹†é™¤':'í•´ì²´','é’¢ç­‹':'ì² ê·¼','æµ‡ç­‘':'íƒ€ì„¤','æ¶å­å·¥':'ë¹„ê³„','ä¿¡å·å‘˜':'ì‹ í˜¸ìˆ˜','äºŒç‚®':'ì•Œí¼','é’¢ç‚®':'ê°±í¼','ç¢çŸ³æŠ¹ç°':'í• ì„ë¯¸ì¥','å®‰å…¨':'ì•ˆì „'
    };
    function convertPositionToKorean(p){ return positionMapping[p] || p; }

    // ===================== åå­—ç¿»è¯‘åŠŸèƒ½ =====================
    // ä¸­æ–‡å¸¸è§å­—åˆ°éŸ©è¯­çš„æ˜ å°„
    const chineseToKorean = {
      'æ':'ì´','ç‹':'ì™•','å¼ ':'ì¥','åˆ˜':'ìœ ','é™ˆ':'ì§„','æ¨':'ì–‘','é»„':'í™©','èµµ':'ì¡°','å´':'ì˜¤','å‘¨':'ì£¼',
      'å¾':'ì„œ','å­™':'ì†','é©¬':'ë§ˆ','æœ±':'ì£¼','èƒ¡':'í˜¸','éƒ­':'ê³½','ä½•':'í•˜','é«˜':'ê³ ','æ—':'ë¦¼','éƒ‘':'ì •'
    };

    // è¶Šå—è¯­åˆ°éŸ©è¯­çš„æ˜ å°„
    const vietnameseToKorean = {
      'Nguyá»…n':'ì›¬','Tráº§n':'ì „','LÃª':'ë ˆ','Pháº¡m':'íŒœ','HoÃ ng':'í™©','Huá»³nh':'í›„ì¸','Phan':'íŒ','VÅ©':'ë¶€','VÃµ':'ë³´','Äáº·ng':'ë‹¹',
      'BÃ¹i':'ë¶€ì´','Äá»—':'ë„','Há»“':'í˜¸','NgÃ´':'ì˜¤','DÆ°Æ¡ng':'ì¤‘','LÃ½':'ë¦¬'
    };

    // ä¿„è¯­å­—æ¯åˆ°éŸ©è¯­çš„æ˜ å°„ï¼ˆåŸºç¡€æ˜ å°„ï¼‰
    const russianToKorean = {
      'Ğ':'ì•„','Ğ‘':'ë¸Œ','Ğ’':'ë¸Œ','Ğ“':'ê·¸','Ğ”':'ë“œ','Ğ•':'ì˜ˆ','Ğ':'ìš”','Ğ–':'ì£¼','Ğ—':'ì¦ˆ','Ğ˜':'ì´',
      'Ğ™':'ì´','Ğš':'í¬','Ğ›':'Ğ»ÑŒ','Ğœ':'ë¯€','Ğ':'ëŠ','Ğ':'ì˜¤','ĞŸ':'í”„','Ğ ':'ë¥´','Ğ¡':'ìŠ¤','Ğ¢':'íŠ¸',
      'Ğ£':'ìš°','Ğ¤':'í”„','Ğ¥':'í','Ğ¦':'ì¸ ','Ğ§':'ì¹˜','Ğ¨':'ì‹œ','Ğ©':'ì‹œ','Ğª':'','Ğ«':'ì´','Ğ¬':'',
      'Ğ­':'ì—','Ğ®':'ìœ ','Ğ¯':'ì•¼',
      'Ğ°':'ì•„','Ğ±':'ë¸Œ','Ğ²':'ë¸Œ','Ğ³':'ê·¸','Ğ´':'ë“œ','Ğµ':'ì˜ˆ','Ñ‘':'ìš”','Ğ¶':'ì£¼','Ğ·':'ì¦ˆ','Ğ¸':'ì´',
      'Ğ¹':'ì´','Ğº':'í¬','Ğ»':'Ğ»ÑŒ','Ğ¼':'ë¯€','Ğ½':'ëŠ','Ğ¾':'ì˜¤','Ğ¿':'í”„','Ñ€':'ë¥´','Ñ':'ìŠ¤','Ñ‚':'íŠ¸',
      'Ñƒ':'ìš°','Ñ„':'í”„','Ñ…':'í','Ñ†':'ì¸ ','Ñ‡':'ì¹˜','Ñˆ':'ì‹œ','Ñ‰':'ì‹œ','ÑŠ':'','Ñ‹':'ì´','ÑŒ':'',
      'Ñ':'ì—','Ñ':'ìœ ','Ñ':'ì•¼'
    };

    // å°†å­—å…¸å¯¹è±¡æŒ‚è½½åˆ°windowä¸Šï¼Œä½¿å…¶å¯ä»¥è¢«å¤–éƒ¨JSONæ–‡ä»¶æ›´æ–°
    window.chineseToKorean = chineseToKorean;
    window.vietnameseToKorean = vietnameseToKorean;
    window.russianToKorean = russianToKorean;
    
    // ä¿„æ–‡å®Œæ•´åå­—ã€åç¼€è§„åˆ™å’Œé›†ç¾¤è§„åˆ™ï¼ˆä»JSONåŠ è½½åå¡«å……ï¼‰
    window.russianUnits = {};
    window.russianSuffix = {};
    window.russianCluster = [];

    function translateName(){
      const name = state.formData['name'];
      if(!name || !name.trim()){
        alert('è¯·å…ˆè¾“å…¥å§“å / ì´ë¦„ì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      let translated = '';
      
      // æ£€æµ‹æ˜¯å¦ä¸ºä¸­æ–‡
      if(/[\u4e00-\u9fa5]/.test(name)){
        // ä¸­æ–‡ç¿»è¯‘
        for(let char of name){
          translated += chineseToKorean[char] || char;
        }
      }
      // æ£€æµ‹æ˜¯å¦ä¸ºè¶Šå—è¯­ï¼ˆæ‹‰ä¸å­—æ¯+å£°è°ƒç¬¦å·ï¼‰
      else if(/[áº áº¢áº¤áº¦áº¨áºªáº¬áº®áº°áº²áº´áº¶áº¸áººáº¼áº¾á»€á»‚Æ°ÄƒÃªÃ´Æ¡Æ¯Ä‚ÃŠÃ”Æ ]/.test(name) || /^[A-Za-z\s]+$/.test(name)){
        // è¶Šå—è¯­ç¿»è¯‘ - æŒ‰ç©ºæ ¼åˆ†å‰²
        const parts = name.split(/\s+/);
        translated = parts.map(part => {
          // å…ˆå°è¯•å®Œæ•´åŒ¹é…
          if(vietnameseToKorean[part]) return vietnameseToKorean[part];
          
          // å°è¯•åŒ¹é…å¼€å¤´çš„è¾…éŸ³ç»„åˆ
          for(let i = 2; i >= 1; i--){
            const prefix = part.substring(0, i);
            if(vietnameseToKorean[prefix]){
              const rest = part.substring(i);
              return vietnameseToKorean[prefix] + translateVietnamesePart(rest);
            }
          }
          
          // é€å­—ç¬¦ç¿»è¯‘
          return translateVietnamesePart(part);
        }).join('');
      }
      // æ£€æµ‹æ˜¯å¦ä¸ºä¿„è¯­è¥¿é‡Œå°”å­—æ¯
      else if(/[Ğ-Ğ¯Ğ°-ÑĞÑ‘]/.test(name)){
        // ä¿„è¯­ç¿»è¯‘ - ä½¿ç”¨æ”¹è¿›çš„ç®—æ³•
        translated = translateRussianName(name);
      }
      else {
        alert('æ— æ³•è¯†åˆ«çš„åå­—æ ¼å¼ / ì´ë¦„ í˜•ì‹ì„ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
      }

      // æ›´æ–°çŠ¶æ€å¹¶é‡æ–°æ¸²æŸ“
      state.formData['name'] = translated;
      render();
    }
    
    // æ”¹è¿›çš„ä¿„æ–‡åå­—ç¿»è¯‘å‡½æ•°
    function translateRussianName(name) {
      // 1. é¦–å…ˆå°è¯•å®Œæ•´åŒ¹é…
      if (window.russianUnits && window.russianUnits[name]) {
        return window.russianUnits[name];
      }
      
      // 2. å°è¯•åç¼€è§„åˆ™åŒ¹é…
      if (window.russianSuffix && Object.keys(window.russianSuffix).length > 0) {
        for (const [suffix, replacement] of Object.entries(window.russianSuffix)) {
          if (name.endsWith(suffix)) {
            const base = name.slice(0, -suffix.length);
            // å°è¯•åŒ¹é…åŸºç¡€éƒ¨åˆ†
            if (window.russianUnits && window.russianUnits[base]) {
              return window.russianUnits[base] + replacement;
            }
            // å¦‚æœåŸºç¡€éƒ¨åˆ†ä¸åœ¨unitsä¸­ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¿”å›
            // è¿™é‡Œå¯ä»¥é€‰æ‹©é€’å½’ç¿»è¯‘baseéƒ¨åˆ†
            return translateRussianName(base) + replacement;
          }
        }
      }
      
      // 3. å°è¯•é›†ç¾¤è§„åˆ™åŒ¹é…
      if (window.russianCluster && window.russianCluster.length > 0) {
        let result = name;
        for (const [pattern, replacement] of window.russianCluster) {
          result = result.replace(new RegExp(pattern, 'g'), replacement);
        }
        if (result !== name) {
          return result;
        }
      }
      
      // 4. é€å­—ç¬¦ç¿»è¯‘ï¼ˆå›é€€æ–¹æ¡ˆï¼‰
      let result = '';
      for(let char of name){
        if(char === ' ') result += '';
        else result += russianToKorean[char] || char;
      }
      return result;
    }

    function translateVietnamesePart(str){
      let result = '';
      for(let char of str){
        const lower = char.toLowerCase();
        if(vietnameseToKorean[lower]){
          result += vietnameseToKorean[lower];
        } else if(/[aeiouÃ´Æ¡Æ°]/.test(lower)){
          // å…ƒéŸ³åŸºæœ¬æ˜ å°„
          const vowelMap = {'a':'ì•„','e':'ì—','i':'ì´','o':'ì˜¤','u':'ìš°','Ã´':'ì–´','Æ¡':'ì–´','Æ°':'ìœ¼'};
          result += vowelMap[lower] || char;
        } else if(/[bcdfghjklmnpqrstvwxyz]/.test(lower)){
          // è¾…éŸ³åŸºæœ¬æ˜ å°„
          const consonantMap = {
            'b':'ë¸Œ','c':'ë„','d':'ë“œ','f':'í”„','g':'ê·¸','h':'í','j':'ì¦ˆ','k':'í¬',
            'l':'Ğ»ÑŒ','m':'ë¯€','n':'ëŠ','p':'í”„','q':'ë„','r':'ë¥´','s':'ìŠ¤','t':'íŠ¸',
            'v':'ë¸Œ','w':'ìš°','x':'ìŠ¤','y':'ì´','z':'ì¦ˆ'
          };
          result += consonantMap[lower] || char;
        } else {
          result += char;
        }
      }
      return result;
    }
    
    // ===================== è™šæ‹Ÿé”®ç›˜åŠŸèƒ½ =====================
    let keyboardVisible = false;
    
    function toggleKeyboard() {
      keyboardVisible = !keyboardVisible;
      render();
    }
    
    function insertChar(char) {
      const currentName = state.formData['name'] || '';
      state.formData['name'] = currentName + char;
      render();
    }
    
    function deleteLastChar() {
      const currentName = state.formData['name'] || '';
      if (currentName.length > 0) {
        state.formData['name'] = currentName.slice(0, -1);
        render();
      }
    }
    
    function clearName() {
      state.formData['name'] = '';
      render();
    }
    
    function getKeyboardChars() {
      const lang = state.language;
      if (lang === 'zh') {
        // ä¸­æ–‡å¸¸ç”¨å­—
        return Object.keys(window.chineseToKorean).slice(0, 100);
      } else if (lang === 'vi') {
        // è¶Šå—æ–‡å¸¸ç”¨å­—æ¯ç»„åˆ
        return Object.keys(window.vietnameseToKorean).slice(0, 100);
      } else if (lang === 'ru') {
        // ä¿„æ–‡å­—æ¯
        const russianAlphabet = [
          'Ğ','Ğ‘','Ğ’','Ğ“','Ğ”','Ğ•','Ğ','Ğ–','Ğ—','Ğ˜','Ğ™','Ğš','Ğ›','Ğœ','Ğ','Ğ','ĞŸ','Ğ ','Ğ¡','Ğ¢','Ğ£','Ğ¤','Ğ¥','Ğ¦','Ğ§','Ğ¨','Ğ©','Ğª','Ğ«','Ğ¬','Ğ­','Ğ®','Ğ¯',
          'Ğ°','Ğ±','Ğ²','Ğ³','Ğ´','Ğµ','Ñ‘','Ğ¶','Ğ·','Ğ¸','Ğ¹','Ğº','Ğ»','Ğ¼','Ğ½','Ğ¾','Ğ¿','Ñ€','Ñ','Ñ‚','Ñƒ','Ñ„','Ñ…','Ñ†','Ñ‡','Ñˆ','Ñ‰','ÑŠ','Ñ‹','ÑŒ','Ñ','Ñ','Ñ'
        ];
        return russianAlphabet;
      }
      return [];
    }

    // ===================== åº”ç”¨çŠ¶æ€ =====================
    let state = {
      language:'zh',
      formData:{},
      signature:null,
      isDrawing:false,
      isAdminMode:false,
      showPasswordPage:false,
      showDownloadPage:false,
      formsGenerated:false,
      firstFormGenerated:false,
      secondFormGenerated:false,
      templates:{ contract:{ zh:null, ko:null }, safety:{ zh:null, ko:null } },
      fieldPositions:{ contract:{ zh:{}, ko:{} }, safety:{ zh:{}, ko:{} } },
      currentTemplate:'contract',
      currentLang:'zh',
      selectedField:null,
      editingField:null,
      multiInstanceMode:false,
      repositionTarget:null,
      positionMode:'select'
    };

    // ===================== å¼ºåˆ¶ä»JSONåŠ è½½é…ç½® =====================
    async function loadDefaultConfig(){
      try{
        const res = await fetch('form-config.json');
        if(res.ok){
          const config = await res.json();
          if(config.templates) state.templates = config.templates;
          if(config.fieldPositions) state.fieldPositions = config.fieldPositions;
          return true;
        }
      }catch(e){ 
        console.error('åŠ è½½form-config.jsonå¤±è´¥:', e); 
      }
      return false;
    }

    function saveToLocalStorage(){
      // å·²ç¦ç”¨ - å¼ºåˆ¶ä½¿ç”¨JSONé…ç½®
    }

    async function initConfig(){
      await loadDefaultConfig();  // å¼ºåˆ¶åªä½¿ç”¨JSONé…ç½®
      render();
    }

    // ===================== å·¥å…·å‡½æ•° =====================
    function getFieldsList(lang){
      if(lang==='ko'){ return ['name','birthday','address','residentNum','phone','position','experience','month','day','checkmark','signature']; }
      return ['name','birthday','address','position','passport','phone','experience','month','day','checkmark','signature'];
    }
    function getCurrentMonth(){ return String(new Date().getMonth()+1); }
    function getCurrentDay(){ return String(new Date().getDate()); }

    // ğŸ‘‰ ç§»åŠ¨ç«¯å…¼å®¹ä¸‹è½½ï¼ˆæ ¸å¿ƒä¿®å¤ç‚¹ï¼‰
    function safeDownloadFromBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.style.display = 'none';
      document.body.appendChild(a);
      
      // è§¦å‘ä¸‹è½½ - ç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯ç»Ÿä¸€å¤„ç†
      try {
        a.click();
      } catch(e) {
        // å¦‚æœclick()å¤±è´¥ï¼Œå°è¯•è§¦å‘è§¦æ‘¸äº‹ä»¶
        const evt = new MouseEvent('click', {
          view: window,
          bubbles: true,
          cancelable: true
        });
        a.dispatchEvent(evt);
      }
      
      // å»¶è¿Ÿç§»é™¤å…ƒç´ å’Œé‡Šæ”¾URLï¼Œç»™æµè§ˆå™¨è¶³å¤Ÿæ—¶é—´å¤„ç†ä¸‹è½½
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 2000);
    }

    // ===================== ç­¾åæ¿ =====================
    let signatureCanvas=null, sigCtx=null;
    function startDrawing(e){
      const rect = signatureCanvas.getBoundingClientRect();
      // è®¡ç®—æ˜¾ç¤ºå°ºå¯¸å’Œå®é™…canvaså°ºå¯¸çš„æ¯”ä¾‹
      const scaleX = signatureCanvas.width / rect.width;
      const scaleY = signatureCanvas.height / rect.height;
      // è·å–è§¦æ‘¸/é¼ æ ‡ä½ç½®å¹¶æŒ‰æ¯”ä¾‹ç¼©æ”¾
      const x = ((e.clientX || e.touches?.[0]?.clientX) - rect.left) * scaleX;
      const y = ((e.clientY || e.touches?.[0]?.clientY) - rect.top) * scaleY;
      sigCtx.beginPath(); sigCtx.moveTo(x,y); state.isDrawing=true;
    }
    function draw(e){
      if(!state.isDrawing) return;
      e.preventDefault();
      const rect = signatureCanvas.getBoundingClientRect();
      // è®¡ç®—æ˜¾ç¤ºå°ºå¯¸å’Œå®é™…canvaså°ºå¯¸çš„æ¯”ä¾‹
      const scaleX = signatureCanvas.width / rect.width;
      const scaleY = signatureCanvas.height / rect.height;
      // è·å–è§¦æ‘¸/é¼ æ ‡ä½ç½®å¹¶æŒ‰æ¯”ä¾‹ç¼©æ”¾
      const x = ((e.clientX || e.touches?.[0]?.clientX) - rect.left) * scaleX;
      const y = ((e.clientY || e.touches?.[0]?.clientY) - rect.top) * scaleY;
      sigCtx.lineTo(x,y); sigCtx.stroke();
    }
    function stopDrawing(){
      if(state.isDrawing){ state.isDrawing=false; state.signature = signatureCanvas.toDataURL(); }
    }
    function clearSignature(){ sigCtx.clearRect(0,0,signatureCanvas.width, signatureCanvas.height); state.signature=null; }

    // ===================== PDFç”Ÿæˆï¼ˆä½¿ç”¨jsPDF+html2canvasï¼‰=====================
    async function generateDocument(templateKey){
      if(!state.signature){
        alert('è¯·å…ˆç­¾å / ì„œëª…ì„ ë¨¼ì € í•´ì£¼ì„¸ìš”');
        return;
      }

      const t = translations[state.language];
      const tpl = state.templates[templateKey][state.language];
      if(!tpl){
        alert('æ¨¡æ¿æœªæ‰¾åˆ° / í…œí”Œë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
      }

      try {
        const { jsPDF } = window.jspdf;
        const positions = state.fieldPositions[templateKey][state.language];

        const img = new Image();
        img.src = tpl;
        await new Promise((res,rej)=>{
          img.onload=res;
          img.onerror=()=>rej(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
        });

        const pdf = new jsPDF({
          orientation: img.width > img.height ? 'landscape' : 'portrait',
          unit: 'mm',
          format: 'a4'
        });

        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const imgAspect = img.width / img.height;
        const pdfAspect = pdfWidth / pdfHeight;
        let drawWidth, drawHeight, offsetX=0, offsetY=0;
        if(imgAspect > pdfAspect){
          drawWidth = pdfWidth;
          drawHeight = pdfWidth / imgAspect;
          offsetY = (pdfHeight - drawHeight)/2;
        } else {
          drawHeight = pdfHeight;
          drawWidth = pdfHeight * imgAspect;
          offsetX = (pdfWidth - drawWidth)/2;
        }
        pdf.addImage(img, 'PNG', offsetX, offsetY, drawWidth, drawHeight);

        const scaleX = drawWidth / img.width;
        const scaleY = drawHeight / img.height;
        pdf.setFontSize(10);

        for(let [fieldName, posArr] of Object.entries(positions)){
          if(!Array.isArray(posArr)) posArr=[posArr];
          for(let pos of posArr){
            let val = state.formData[fieldName];
            if(fieldName==='name' && state.language!=='ko' && val) val += ' (' + val + ')';
            if(fieldName==='position' && state.language!=='ko' && val) val = convertPositionToKorean(val);
            if(fieldName==='checkmark') val='âœ”';
            if(fieldName==='month') val=getCurrentMonth();
            if(fieldName==='day') val=getCurrentDay();
            if(fieldName==='signature' && state.signature) val='[å·²ç­¾å]';

            if(val){
              const x = offsetX + pos.x * scaleX;
              const y = offsetY + pos.y * scaleY;
              const fsize = pos.fontSize || 10;
              pdf.setFontSize(fsize);
              if(fieldName==='signature' && state.signature){
                const sigW = (pos.width||50)*scaleX, sigH=(pos.height||20)*scaleY;
                pdf.addImage(state.signature, 'PNG', x, y, sigW, sigH);
              } else {
                pdf.text(String(val), x, y + fsize*0.35);
              }
            }
          }
        }

        const blob = pdf.output('blob');
        const filename = `${templateKey}_${state.language}_${new Date().getTime()}.pdf`;
        safeDownloadFromBlob(blob, filename);

        if(templateKey==='contract'){ 
          state.firstFormGenerated=true; 
        } else if(templateKey==='safety'){ 
          state.secondFormGenerated=true; 
        }
        state.formsGenerated = state.firstFormGenerated && state.secondFormGenerated;
        render();
      } catch(e){
        console.error('PDFç”Ÿæˆå¤±è´¥:', e);
        alert('PDFç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    // ===================== ç”¨æˆ·æ¨¡å¼æ¸²æŸ“ =====================
    function renderUserMode(){
      const t = translations[state.language];
      const lang = state.language;

      if(state.showDownloadPage){
        return `
          <div class="container">
            <h1>${t.downloadTitle}</h1>
            <p class="note" style="margin-bottom:30px;">${t.downloadHint}</p>
            <button class="generate-btn" onclick="generateDocument('contract')" ${state.firstFormGenerated?'disabled':''}>
              ${state.firstFormGenerated?'âœ… ':''} ${t.generateFirst}
            </button>
            <button class="generate-btn" onclick="generateDocument('safety')" ${state.secondFormGenerated?'disabled':''}>
              ${state.secondFormGenerated?'âœ… ':''} ${t.generateSecond}
            </button>
            <button class="generate-btn" onclick="openSmsApp()" ${!state.formsGenerated?'disabled':''}>
              ${t.sendToAdmin}
            </button>
            <button class="generate-btn" onclick="state.showDownloadPage=false;render();" style="background:#6c757d;margin-top:20px;">
              ${t.backToForm}
            </button>
          </div>
        `;
      }

      // æ­£å¸¸è¡¨å•
      return `
        <div class="container">
          <h1>${t.title}</h1>
          
          <div class="form-group">
            <label>${t.selectLanguage}</label>
            <div class="language-buttons">
              <button class="lang-btn ${lang==='zh'?'active':''}" onclick="state.language='zh';keyboardVisible=false;render();">ä¸­æ–‡</button>
              <button class="lang-btn ${lang==='ko'?'active':''}" onclick="state.language='ko';keyboardVisible=false;render();">í•œêµ­ì–´</button>
              <button class="lang-btn ${lang==='vi'?'active':''}" onclick="state.language='vi';keyboardVisible=false;render();">Tiáº¿ng Viá»‡t</button>
              <button class="lang-btn ${lang==='ru'?'active':''}" onclick="state.language='ru';keyboardVisible=false;render();">Ğ ÑƒÑÑĞºĞ¸Ğ¹</button>
            </div>
          </div>

          <div class="form-group">
            <label>${t.name}</label>
            <div class="name-input-container">
              <input type="text" value="${state.formData['name']||''}" onchange="state.formData['name']=this.value;render();" placeholder="${t.name}" />
              ${lang !== 'ko' ? `
                <button class="keyboard-toggle-btn" onclick="toggleKeyboard()">
                  ${keyboardVisible ? 'éšè—' : 'âŒ¨ï¸'}
                </button>
              ` : ''}
            </div>
            ${lang !== 'ko' && keyboardVisible ? `
              <div class="virtual-keyboard">
                <div class="keyboard-title">${t.keyboardHint}</div>
                <div class="keyboard-grid">
                  ${getKeyboardChars().map(char => `
                    <button class="char-btn" onclick="insertChar('${char}')">${char}</button>
                  `).join('')}
                </div>
                <div class="keyboard-controls">
                  <button class="keyboard-control-btn" onclick="deleteLastChar()">âŒ« åˆ é™¤</button>
                  <button class="keyboard-control-btn" onclick="clearName()">âœ• æ¸…ç©º</button>
                </div>
              </div>
            ` : ''}
            ${lang!=='ko'?`<button class="generate-btn" style="margin-top:10px;" onclick="translateName()">${t.translateName}</button>`:''}
          </div>

          <div class="form-group">
            <label>${t.birthday}</label>
            <input type="date" value="${state.formData['birthday']||''}" onchange="state.formData['birthday']=this.value" />
          </div>

          <div class="form-group">
            <label>${t.address}</label>
            <input type="text" value="${state.formData['address']||''}" onchange="state.formData['address']=this.value" placeholder="${t.address}" />
            <p class="note">${t.addressHint}</p>
          </div>

          ${lang==='ko'?`
            <div class="form-group">
              <label>${t.residentNum}</label>
              <input type="text" value="${state.formData['residentNum']||''}" onchange="state.formData['residentNum']=this.value" placeholder="${t.residentNum}" />
            </div>
          `:`
            <div class="form-group">
              <label>${t.passport}</label>
              <input type="text" value="${state.formData['passport']||''}" onchange="state.formData['passport']=this.value" placeholder="${t.passport}" />
            </div>
          `}

          <div class="form-group">
            <label>${t.phone}</label>
            <input type="text" value="${state.formData['phone']||''}" onchange="state.formData['phone']=this.value" placeholder="${t.phone}" />
          </div>

          <div class="form-group">
            <label>${t.position}</label>
            <select onchange="state.formData['position']=this.value">
              <option value="">${t.positionSelect}</option>
              ${positionOptions[lang].map(p=>`<option value="${p}" ${state.formData['position']===p?'selected':''}>${p}</option>`).join('')}
            </select>
          </div>

          <div class="form-group">
            <label>${t.experience}</label>
            <input type="number" min="0" value="${state.formData['experience']||''}" onchange="state.formData['experience']=this.value" placeholder="${t.experienceYears}" />
          </div>

          <div class="form-group">
            <label>${t.signature}</label>
            <div class="signature-container">
              <canvas id="signatureCanvas" width="600" height="200"></canvas>
            </div>
            <button class="clear-btn" onclick="clearSignature()">${t.clearSignature}</button>
          </div>

          <button class="generate-btn" onclick="state.showDownloadPage=true;render();">
            ${t.generate}
          </button>

          <div class="mode-switch">
            <span>ç®¡ç†å‘˜? / ê´€ë¦¬ì?</span>
            <button class="toggle-btn" onclick="state.showPasswordPage=true;render();">${t.adminMode}</button>
          </div>
        </div>
      `;
    }

    // ===================== ç®¡ç†å‘˜æ¨¡å¼æ¸²æŸ“ =====================
    function renderAdminMode(){
      const t = translations['zh'];
      const tpl = state.currentTemplate;
      const lang = state.currentLang;
      const pos = state.fieldPositions[tpl][lang];
      const imgSrc = state.templates[tpl][lang];

      return `
        <div class="container admin-container">
          <div class="admin-header">
            <h1 class="admin-title">ç®¡ç†å‘˜é…ç½®é¢æ¿</h1>
            <button class="toggle-btn" onclick="state.isAdminMode=false;render();">è¿”å›ç”¨æˆ·æ¨¡å¼</button>
          </div>

          <div class="admin-layout">
            <div class="left-panel">
              <div class="section-title">æ¨¡æ¿é¢„è§ˆä¸å­—æ®µå®šä½</div>
              
              <div class="template-tabs">
                <button class="tab-btn ${tpl==='contract'?'active':''}" onclick="state.currentTemplate='contract';render();">åŠ³åŠ¨åˆåŒ</button>
                <button class="tab-btn ${tpl==='safety'?'active':''}" onclick="state.currentTemplate='safety';render();">å®‰å…¨åè®®</button>
              </div>

              <div class="language-tabs">
                <button class="tab-btn ${lang==='zh'?'active':''}" onclick="state.currentLang='zh';render();">ä¸­æ–‡æ¨¡æ¿</button>
                <button class="tab-btn ${lang==='ko'?'active':''}" onclick="state.currentLang='ko';render();">éŸ©è¯­æ¨¡æ¿</button>
              </div>

              <div class="upload-section">
                <label>ä¸Šä¼ æ¨¡æ¿å›¾ç‰‡ï¼š</label>
                <input type="file" accept="image/*" onchange="handleTemplateUpload(event,'${tpl}','${lang}')" />
              </div>

              ${imgSrc?`
                <div class="preview-box">
                  <div class="image-wrapper">
                    <img src="${imgSrc}" id="templatePreview" onclick="handleImageClick(event)" />
                    <div id="markersContainer">${renderMarkers(pos)}</div>
                  </div>
                </div>
              `:'<p>æœªä¸Šä¼ æ¨¡æ¿å›¾ç‰‡</p>'}
            </div>

            <div class="right-panel">
              <div class="section-title">å­—æ®µç®¡ç†</div>
              <div class="field-buttons">
                ${getFieldsList(lang).map(f=>`
                  <button class="field-btn ${state.selectedField===f?'active':''}" onclick="selectField('${f}')">${f}</button>
                `).join('')}
              </div>
              
              ${state.selectedField?`
                <div style="background:#F0F8F9;padding:15px;border-radius:8px;margin-bottom:20px;border:2px solid #3E5F8A;">
                  <p><strong>é€‰ä¸­å­—æ®µï¼š</strong> ${state.selectedField}</p>
                  <p>ç‚¹å‡»å›¾ç‰‡ä¸Šçš„ä½ç½®æ¥å®šä½æ­¤å­—æ®µ</p>
                  <label style="margin-top:10px;display:flex;align-items:center;gap:8px;">
                    <input type="checkbox" ${state.multiInstanceMode?'checked':''} onchange="state.multiInstanceMode=this.checked;render();" />
                    å¤šå®ä¾‹æ¨¡å¼ï¼ˆå…è®¸åŒä¸€å­—æ®µå¤šä¸ªä½ç½®ï¼‰
                  </label>
                </div>
              `:'<p style="color:#999;text-align:center;">è¯·é€‰æ‹©ä¸€ä¸ªå­—æ®µ</p>'}

              <div class="field-list">
                <div class="section-title">å·²å®šä½å­—æ®µ</div>
                ${Object.keys(pos).length>0?Object.entries(pos).map(([fieldName,posArr])=>{
                  if(!Array.isArray(posArr)) posArr=[posArr];
                  return posArr.map((p,idx)=>`
                    <div class="field-item">
                      <div class="field-item-header">
                        <span class="field-name">${fieldName}${posArr.length>1?' #'+(idx+1):''}</span>
                        <div class="field-actions">
                          <button class="edit-btn" onclick="editFieldParams('${fieldName}',${idx})">ç¼–è¾‘å‚æ•°</button>
                          <button class="reposition-btn" onclick="repositionField('${fieldName}',${idx})">é‡æ–°å®šä½</button>
                          <button class="delete-btn" onclick="deleteFieldPosition('${fieldName}',${idx})">åˆ é™¤</button>
                        </div>
                      </div>
                      <div style="font-size:12px;color:#666;">
                        ä½ç½®: (${Math.round(p.x)}, ${Math.round(p.y)}) | å­—å·: ${p.fontSize||10}
                        ${p.width?' | å®½:'+p.width:''}${p.height?' | é«˜:'+p.height:''}
                      </div>
                      ${state.editingField===fieldName+'-'+idx?`
                        <div class="param-editor">
                          <div class="param-row">
                            <span class="param-label">Xåæ ‡:</span>
                            <input type="number" id="editX" value="${p.x}" />
                          </div>
                          <div class="param-row">
                            <span class="param-label">Yåæ ‡:</span>
                            <input type="number" id="editY" value="${p.y}" />
                          </div>
                          <div class="param-row">
                            <span class="param-label">å­—å·:</span>
                            <input type="number" id="editFontSize" value="${p.fontSize||10}" />
                          </div>
                          ${fieldName==='signature'?`
                            <div class="param-row">
                              <span class="param-label">å®½åº¦:</span>
                              <input type="number" id="editWidth" value="${p.width||50}" />
                            </div>
                            <div class="param-row">
                              <span class="param-label">é«˜åº¦:</span>
                              <input type="number" id="editHeight" value="${p.height||20}" />
                            </div>
                          `:''}
                          <button class="save-param-btn" onclick="saveFieldParams('${fieldName}',${idx})">ä¿å­˜å‚æ•°</button>
                        </div>
                      `:''}
                    </div>
                  `).join('');
                }).join(''):'<p style="text-align:center;color:#999;">æš‚æ— å­—æ®µå®šä½</p>'}
              </div>

              <button class="generate-btn" onclick="downloadConfig()" style="margin-top:20px;">
                ä¸‹è½½é…ç½®JSON
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderMarkers(positions){
      let html='';
      let idx=1;
      for(let [fieldName,posArr] of Object.entries(positions)){
        if(!Array.isArray(posArr)) posArr=[posArr];
        posArr.forEach((pos,i)=>{
          html+=`
            <div class="field-marker" style="left:${pos.x}px;top:${pos.y}px;">${idx}</div>
            <div class="field-label" style="left:${pos.x}px;top:${pos.y}px;">${fieldName}${posArr.length>1?' #'+(i+1):''}</div>
          `;
          idx++;
        });
      }
      return html;
    }

    function selectField(fieldName){
      state.selectedField = fieldName;
      render();
    }

    function handleImageClick(e){
      if(!state.selectedField){
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå­—æ®µ');
        return;
      }
      const img = e.target;
      const rect = img.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      const tpl=state.currentTemplate, lang=state.currentLang;
      const fieldName = state.selectedField;

      if(state.repositionTarget){
        // é‡æ–°å®šä½æ¨¡å¼
        const [targetField, targetIdx] = state.repositionTarget.split('-').map((v,i)=>i===1?parseInt(v):v);
        let posArr = state.fieldPositions[tpl][lang][targetField];
        if(!Array.isArray(posArr)) posArr=[posArr];
        posArr[targetIdx].x = x;
        posArr[targetIdx].y = y;
        if(posArr.length===1) state.fieldPositions[tpl][lang][targetField]=posArr[0];
        else state.fieldPositions[tpl][lang][targetField]=posArr;
        state.repositionTarget=null;
        alert('ä½ç½®å·²æ›´æ–°');
      } else {
        // æ–°å¢ä½ç½®
        const newPos = { x, y, fontSize:10 };
        if(fieldName==='signature'){ newPos.width=50; newPos.height=20; }

        if(state.multiInstanceMode){
          let existing = state.fieldPositions[tpl][lang][fieldName];
          if(!existing){ state.fieldPositions[tpl][lang][fieldName]=[newPos]; }
          else {
            if(!Array.isArray(existing)) existing=[existing];
            existing.push(newPos);
            state.fieldPositions[tpl][lang][fieldName]=existing;
          }
        } else {
          state.fieldPositions[tpl][lang][fieldName] = newPos;
        }
      }
      render();
    }

    function repositionField(fieldName, idx){
      state.repositionTarget = fieldName+'-'+idx;
      alert('è¯·åœ¨å›¾ç‰‡ä¸Šç‚¹å‡»æ–°çš„ä½ç½®');
    }

    function deleteFieldPosition(fieldName, idx){
      const tpl=state.currentTemplate, lang=state.currentLang;
      let posArr = state.fieldPositions[tpl][lang][fieldName];
      if(!Array.isArray(posArr)) posArr=[posArr];
      posArr.splice(idx,1);
      if(posArr.length===0) delete state.fieldPositions[tpl][lang][fieldName];
      else if(posArr.length===1) state.fieldPositions[tpl][lang][fieldName]=posArr[0];
      else state.fieldPositions[tpl][lang][fieldName]=posArr;
      render();
    }

    function editFieldParams(fieldName, idx){
      state.editingField = fieldName+'-'+idx;
      render();
    }

    function saveFieldParams(fieldName, idx){
      const tpl=state.currentTemplate, lang=state.currentLang;
      let posArr = state.fieldPositions[tpl][lang][fieldName];
      if(!Array.isArray(posArr)) posArr=[posArr];
      
      posArr[idx].x = parseFloat(document.getElementById('editX').value);
      posArr[idx].y = parseFloat(document.getElementById('editY').value);
      posArr[idx].fontSize = parseInt(document.getElementById('editFontSize').value);
      
      if(fieldName==='signature'){
        posArr[idx].width = parseInt(document.getElementById('editWidth').value);
        posArr[idx].height = parseInt(document.getElementById('editHeight').value);
      }

      if(posArr.length===1) state.fieldPositions[tpl][lang][fieldName]=posArr[0];
      else state.fieldPositions[tpl][lang][fieldName]=posArr;
      
      state.editingField=null;
      render();
    }

    function handleTemplateUpload(e, tpl, lang){
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (ev)=>{
        state.templates[tpl][lang] = ev.target.result;
        render();
      };
      reader.readAsDataURL(file);
    }

    function downloadConfig(){
      const config = {
        templates: state.templates,
        fieldPositions: state.fieldPositions
      };
      const blob = new Blob([JSON.stringify(config, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href=url;
      a.download='form-config.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    // ===================== å¯†ç éªŒè¯é¡µé¢ =====================
    function renderPasswordPage(){
      return `
        <div class="container password-container">
          <div class="password-title">ğŸ”’ ç®¡ç†å‘˜éªŒè¯</div>
          <div class="password-subtitle">è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç </div>
          <input type="password" class="password-input" id="adminPassword" placeholder="è¯·è¾“å…¥å¯†ç " />
          <button class="password-btn" onclick="checkPassword()">ç¡®è®¤</button>
          <div class="password-error" id="passwordError">å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</div>
          <button class="clear-btn" onclick="state.showPasswordPage=false;render();" style="margin-top:20px;">è¿”å›</button>
        </div>
      `;
    }

    function checkPassword(){
      const pwd = document.getElementById('adminPassword').value;
      const correctPwd = '1234';
      if(pwd === correctPwd){
        state.isAdminMode = true;
        state.showPasswordPage = false;
        render();
      } else {
        document.getElementById('passwordError').classList.add('show');
      }
    }

    // ===================== æ‰“å¼€çŸ­ä¿¡åº”ç”¨ =====================
    function openSmsApp(){
      const phone = '010-3742-0131';
      const cleanPhone = phone.replace(/\D/g, '');
      const smsUrl = `sms:${cleanPhone}`;
      try {
        window.location.href = smsUrl;
      } catch(e) {
        window.open(smsUrl, '_self');
      }
    }

    // ===================== ä¸»æ¸²æŸ“å…¥å£ =====================
    function render(){
      const app = document.getElementById('app');
      if(state.showPasswordPage){ app.innerHTML = renderPasswordPage(); return; }
      app.innerHTML = state.isAdminMode ? renderAdminMode() : renderUserMode();

      // ç»‘å®šç­¾åæ¿
      const canvas = document.getElementById('signatureCanvas');
      if(canvas){
        signatureCanvas = canvas; sigCtx = canvas.getContext('2d'); sigCtx.lineWidth = 2; sigCtx.lineCap='round';
        canvas.addEventListener('mousedown', startDrawing); canvas.addEventListener('mousemove', draw); window.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing, {passive:true}); canvas.addEventListener('touchmove', draw, {passive:false}); window.addEventListener('touchend', stopDrawing);
      }
    }

    // åˆå§‹åŒ–
    initConfig();
  </script>

<script>
/* åŠ è½½å¤–éƒ¨å­—å…¸æ–‡ä»¶ï¼šchinese_char_map.json, vietnamese_char_map.json, russian_char_map.json
   å°†å®ƒä»¬åˆå¹¶åˆ°å†…å­˜ä¸­çš„æ˜ å°„è¡¨ä¸­ã€‚ä¿ç•™ç°æœ‰çš„æ˜ å°„ä½œä¸ºå›é€€æ–¹æ¡ˆã€‚
*/
(function(){
  // åŠ è½½ä¸­æ–‡å­—å…¸
  fetch('chinese_char_map.json')
    .then(r=>{ if(!r.ok) throw new Error('no chinese dict'); return r.json(); })
    .then(data=>{
      // åˆå¹¶ä¸­æ–‡å§“æ°æ˜ å°„
      if(data.chineseSurnameMap){
        Object.assign(window.chineseToKorean, data.chineseSurnameMap);
        console.log('âœ… Chinese surname map loaded:', Object.keys(data.chineseSurnameMap).length, 'entries');
      }
      // åˆå¹¶ä¸­æ–‡å­—ç¬¦æ˜ å°„
      if(data.chineseCharMap){
        Object.assign(window.chineseToKorean, data.chineseCharMap);
        console.log('âœ… Chinese character map loaded:', Object.keys(data.chineseCharMap).length, 'entries');
      }
      console.log('âœ… chinese_char_map.json loaded successfully.');
    })
    .catch(err=>{
      console.log('âŒ chinese_char_map.json not found or failed to load:', err.message);
    });

  // åŠ è½½è¶Šå—æ–‡å­—å…¸  
  fetch('vietnamese_char_map.json')
    .then(r=>{ if(!r.ok) throw new Error('no vietnamese dict'); return r.json(); })
    .then(data=>{
      // ç›´æ¥åˆå¹¶è¶Šå—æ–‡æ˜ å°„ï¼ˆå®ƒæ˜¯ä¸€ä¸ªç®€å•çš„é”®å€¼å¯¹å¯¹è±¡ï¼‰
      Object.assign(window.vietnameseToKorean, data);
      console.log('âœ… Vietnamese character map loaded:', Object.keys(data).length, 'entries');
      console.log('âœ… vietnamese_char_map.json loaded successfully.');
    })
    .catch(err=>{
      console.log('âŒ vietnamese_char_map.json not found or failed to load:', err.message);
    });
  
  // åŠ è½½ä¿„æ–‡å­—å…¸
  fetch('russian_char_map.json')
    .then(r=>{ if(!r.ok) throw new Error('no russian dict'); return r.json(); })
    .then(data=>{
      // åˆå¹¶ä¿„æ–‡å®Œæ•´åå­—æ˜ å°„
      if(data.units){
        window.russianUnits = data.units;
        console.log('âœ… Russian name units loaded:', Object.keys(data.units).length, 'entries');
      }
      // åŠ è½½åç¼€è§„åˆ™
      if(data.suffix){
        window.russianSuffix = data.suffix;
        console.log('âœ… Russian suffix rules loaded:', Object.keys(data.suffix).length, 'rules');
      }
      // åŠ è½½é›†ç¾¤è§„åˆ™
      if(data.cluster && Array.isArray(data.cluster)){
        window.russianCluster = data.cluster;
        console.log('âœ… Russian cluster rules loaded:', data.cluster.length, 'rules');
      }
      console.log('âœ… russian_char_map.json loaded successfully.');
    })
    .catch(err=>{
      console.log('âŒ russian_char_map.json not found or failed to load:', err.message);
    });
})();
</script>

<!-- å¼•å…¥jsPDFå’Œhtml2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</body>

</html>
